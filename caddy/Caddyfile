{$EXT_CADDY_BASE_DOMAIN} http://hip.local {

	encode gzip zstd

	#tls /etc/caddy/cert.pem /etc/caddy/key.pem

	root * /var/www/html
	file_server
	log {
		output file     /var/log/nextcloud.log
	}
	php_fastcgi localhost:9000

	header {
		# enable HSTS
		Strict-Transport-Security max-age=31536000;
	}

	redir /.well-known/carddav /remote.php/dav 301
	redir /.well-known/caldav /remote.php/dav 301

	handle /api/v1/* {
		reverse_proxy {$GATEWAY_REVERSE_PROXY}
	}

	# ghostfs
	redir /fs /fs/
	route /fs/* {
		uri strip_prefix /fs
		reverse_proxy localhost:3446 {
			health_uri /ok
			health_interval 10s

			header_up Host {http.request.host}
			header_up X-Real-IP {http.request.remote.host}
			header_up X-Forwarded-For {http.request.remote.host}
		}
	}

	redir /collab-fs /collab-fs/
	route /collab-fs/* {
		uri strip_prefix /collab-fs
		reverse_proxy localhost:3449 {
			health_uri /ok
			health_interval 10s

			header_up Host {http.request.host}
			header_up X-Real-IP {http.request.remote.host}
			header_up X-Forwarded-For {http.request.remote.host}
		}
	}

	# .htaccess / data / config / ... shouldn't be accessible from outside
	@forbidden {
		path    /.htaccess
		path    /data/*
		path    /config/*
		path    /db_structure
		path    /.xml
		path    /README
		path    /3rdparty/*
		path    /lib/*
		path    /templates/*
		path    /occ
		path    /console.php
	}

	respond @forbidden 404
}

# Handle Keycloak routes only if enabled
{$EXT_CADDY_KEYCLOAK_DOMAIN} {
	@enabled {
		expression {env.EXT_CADDY_KEYCLOAK_LISTEN_ENABLED} == "1"
	}
	route /* {
		reverse_proxy {$KEYCLOAK_CADDY_URL:localhost:8080} {
			health_uri /
			health_interval 10s

			header_up Host {http.request.host}
			header_up X-Real-IP {http.request.remote.host}
		}
	}
}

# Handle Keycloak routes only if enabled
{$EXT_CADDY_APP_IN_BROWSER_DOMAIN} {
	@enabled {
		expression {env.EXT_CADDY_APP_IN_BROWSER_LISTEN_ENABLED} == "1"
	}
	route /* {
		reverse_proxy http://hip.local:9001 {
			health_uri /api/ok
			health_interval 10s

			header_up Host {http.request.host}
			header_up X-Real-IP {http.request.remote.host}
		}
	}
}
